# =============================================================================
# Python Backend Development Dockerfile
# =============================================================================
# Optimized for development with hot reload
# =============================================================================

FROM python:3.13-slim

WORKDIR /app

# Install uv and runtime dependencies (curl for health checks, ffmpeg for video processing)
COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/*

# Copy dependency files first (for layer caching)
COPY pyproject.toml uv.lock ./

# Install dependencies
RUN uv sync --frozen

# Set environment variables
ENV PATH="/app/.venv/bin:$PATH"
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# Note: Source code is mounted as volume, not copied
# This enables hot reload

# Copy entrypoint script (source code mounted at runtime)
COPY docker-entrypoint.sh /app/docker-entrypoint.sh
RUN chmod +x /app/docker-entrypoint.sh

EXPOSE 8000

# Run migrations on startup, then start with hot reload
ENTRYPOINT ["/app/docker-entrypoint.sh"]
CMD ["uv", "run", "fastapi", "dev", "--host", "0.0.0.0"]
